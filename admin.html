<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Studio Merchan | Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f4f6f9;
      }
      .sidebar {
        min-height: 100vh;
        background-color: #003766;
        color: white;
      }
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div
      id="login-screen"
      class="container d-flex justify-content-center align-items-center vh-100"
    >
      <div class="card shadow p-5" style="width: 400px">
        <h3 class="text-center mb-4 fw-bold" style="color: #003766">
          ADMIN LOGIN
        </h3>
        <input
          type="email"
          id="login-email"
          class="form-control mb-3"
          placeholder="Email"
        />
        <input
          type="password"
          id="login-password"
          class="form-control mb-3"
          placeholder="Password"
        />
        <button
          onclick="login()"
          class="btn btn-primary w-100 fw-bold"
          style="background-color: #c9761c; border: none"
        >
          ENTER STUDIO
        </button>
        <p id="login-error" class="text-danger text-center mt-3 small"></p>
      </div>
    </div>

    <div id="dashboard-screen" class="container-fluid hidden">
      <div class="row">
        <div class="col-md-2 sidebar p-3">
          <h4 class="mb-4 text-center fw-bold text-warning">MERCHAN CMS</h4>
          <button onclick="logout()" class="btn btn-outline-light w-100 mt-5">
            Log Out
          </button>
        </div>

        <div class="col-md-10 p-5">
          <h2 class="mb-4">Manage Carousel (Fixed 5 Slots)</h2>

          <div class="card shadow p-4" style="max-width: 800px">
            <div class="mb-4 p-3 bg-light border rounded">
              <label class="fw-bold mb-2">Select which Slot to Edit:</label>
              <select
                id="slot-selector"
                class="form-select form-select-lg"
                onchange="loadSlotData()"
              >
                <option value="1">Slot 1 (First Slide)</option>
                <option value="2">Slot 2</option>
                <option value="3">Slot 3</option>
                <option value="4">Slot 4</option>
                <option value="5">Slot 5 (Last Slide)</option>
              </select>
            </div>

            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Artist Name</label>
                <input type="text" id="art-name" class="form-control" />
              </div>

              <div class="col-12">
                <label class="form-label">Google Drive Image Link</label>
                <input type="text" id="art-link" class="form-control" />
                <div class="form-text text-muted">
                  Paste the standard "Share" link. We convert it automatically.
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label"
                  ><i class="bi bi-facebook"></i> Facebook</label
                >
                <input type="text" id="art-fb" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label"
                  ><i class="bi bi-instagram"></i> Instagram</label
                >
                <input type="text" id="art-ig" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label"
                  ><i class="bi bi-soundwave"></i> SoundCloud</label
                >
                <input type="text" id="art-sc" class="form-control" />
              </div>
            </div>

            <div class="mt-4 text-end">
              <button onclick="saveSlot()" class="btn btn-success px-5 fw-bold">
                UPDATE SLOT
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // --- CONFIG ---
      const firebaseConfig = {
        // PASTE YOUR KEYS HERE
        apiKey: "AIzaSyBd-IxyiDnyfwv7XDntnfHesmqD4_p8fzo",
        authDomain: "studio-merchan.firebaseapp.com",
        projectId: "studio-merchan",
        storageBucket: "studio-merchan.firebasestorage.app",
        messagingSenderId: "148020122490",
        appId: "1:148020122490:web:5c06af526e6b47a77b3cc3",
        measurementId: "G-QMC8J9PP9D",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- AUTH ---
      window.login = () => {
        const e = document.getElementById("login-email").value;
        const p = document.getElementById("login-password").value;
        signInWithEmailAndPassword(auth, e, p).catch((err) =>
          alert(err.message)
        );
      };
      window.logout = () => signOut(auth);

      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById("login-screen").classList.add("hidden");
          document
            .getElementById("dashboard-screen")
            .classList.remove("hidden");
          loadSlotData(); // Load Slot 1 immediately
        } else {
          document.getElementById("login-screen").classList.remove("hidden");
          document.getElementById("dashboard-screen").classList.add("hidden");
        }
      });

      // --- LOAD DATA (When dropdown changes) ---
      window.loadSlotData = async () => {
        const slotNum = document.getElementById("slot-selector").value;
        const docId = "artist_" + slotNum; // e.g., "artist_1"

        // Clear inputs first to avoid confusion
        document.querySelectorAll("input").forEach((i) => (i.value = ""));

        try {
          const docSnap = await getDoc(doc(db, "featured_artists", docId));

          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("art-name").value = data.name || "";
            // Show the original drive link if possible, or the converted one
            document.getElementById("art-link").value = data.image_url || "";
            document.getElementById("art-fb").value = data.fb_link || "";
            document.getElementById("art-ig").value = data.ig_link || "";
            document.getElementById("art-sc").value = data.sc_link || "";
          } else {
            console.log("Slot is empty. Ready for new data.");
          }
        } catch (e) {
          console.error("Error loading slot:", e);
        }
      };

      // --- SAVE DATA (Overwrite the specific slot) ---
      window.saveSlot = async () => {
        const slotNum = document.getElementById("slot-selector").value;
        const docId = "artist_" + slotNum; // Force ID to be artist_1, artist_2, etc.

        const name = document.getElementById("art-name").value;
        const rawLink = document.getElementById("art-link").value;

        if (!name || !rawLink) {
          alert("Name and Image are required!");
          return;
        }

        // Link Converter
        let finalImg = rawLink;
        const idMatch = rawLink.match(/\/d\/(.+?)\//);
        if (idMatch && idMatch[1]) {
          finalImg = `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
        }

        try {
          await setDoc(doc(db, "featured_artists", docId), {
            name: name,
            image_url: finalImg,
            fb_link: document.getElementById("art-fb").value || "#",
            ig_link: document.getElementById("art-ig").value || "#",
            sc_link: document.getElementById("art-sc").value || "#",
            order: Number(slotNum), // The order is just the slot number
          });
          alert(`Success! Slot ${slotNum} updated.`);
        } catch (e) {
          alert("Error: " + e.message);
        }
      };
    </script>
  </body>
</html>
